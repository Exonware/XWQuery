// EQL Grammar for Lark
// Event Query Language (Elastic/Endgame)
// Query language for event-based data

?start: query

query: sequence_query
     | event_query

// Sequence query (ordered events)
sequence_query: SEQUENCE [sequence_params] "[" event_filter ("," event_filter)+ "]" [UNTIL event_filter]

sequence_params: BY field_name
               | WITH MAXSPAN "=" timespan

event_filter: event_type WHERE expression

event_type: IDENTIFIER

// Single event query
event_query: event_type WHERE expression

// WHERE expression
expression: or_expr

or_expr: and_expr (OR and_expr)*

and_expr: not_expr (AND not_expr)*

not_expr: NOT? comparison

comparison: additive [compare_op additive]
          | field_ref IN value_list
          | field_ref LIKE STRING
          | field_ref REGEX STRING

compare_op: "==" | "!=" | "<" | ">" | "<=" | ">="

additive: multiplicative (("+" | "-") multiplicative)*

multiplicative: unary (("*" | "/" | "%") unary)*

unary: ("+" | "-")? primary

primary: literal
       | field_ref
       | function_call
       | "(" expression ")"

// Field references with nested paths
field_ref: field_name ("." field_name)*
         | field_name "[" NUMBER "]"

field_name: IDENTIFIER

// Functions
function_call: function_name "(" [arg_list] ")"

function_name: LENGTH | CONCAT | SUBSTRING | INDEXOF
             | STARTSWITH | ENDSWITH | STRING_CONTAINS
             | NUMBER_FUNC | CIDR_MATCH
             | WILDCARD

arg_list: expression ("," expression)*

value_list: "(" expression ("," expression)* ")"

timespan: NUMBER time_unit

time_unit: "s" | "m" | "h" | "d"

literal: STRING | NUMBER | BOOLEAN_LITERAL | NULL | ip_literal

ip_literal: /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(\/\d{1,2})?/  // IPv4 CIDR

// Keywords
SEQUENCE: "sequence"
BY: "by"
WHERE: "where"
WITH: "with"
MAXSPAN: "maxspan"
UNTIL: "until"
AND: "and"
OR: "or"
NOT: "not"
IN: "in"
LIKE: "like"
REGEX: "regex"

// Functions
LENGTH: "length"
CONCAT: "concat"
SUBSTRING: "substring"
INDEXOF: "indexOf"
STARTSWITH: "startsWith"
ENDSWITH: "endsWith"
STRING_CONTAINS: "stringContains"
NUMBER_FUNC: "number"
CIDR_MATCH: "cidrMatch"
WILDCARD: "wildcard"

BOOLEAN_LITERAL: "true" | "false"

NULL: "null"

// Terminals
IDENTIFIER: /[a-zA-Z_][a-zA-Z0-9_]*/
STRING: /"[^"]*"/ | /'[^']*'/
NUMBER: /-?\d+(\.\d+)?/

%import common.WS
%ignore WS

