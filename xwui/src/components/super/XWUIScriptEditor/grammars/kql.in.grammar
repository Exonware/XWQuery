// KQL Grammar for Lark
// Kusto Query Language (Azure Data Explorer)
// Pipeline-based query language

?start: query

// KQL uses pipelines: table | operator | operator
query: table_source ("|" operator)*

table_source: IDENTIFIER [params]

params: "(" param_list ")"

param_list: param ("," param)*

param: IDENTIFIER "=" expression

// KQL Operators
operator: where_op
        | project_op
        | extend_op
        | summarize_op
        | order_op
        | take_op
        | top_op
        | join_op
        | union_op
        | distinct_op
        | count_op
        | render_op

where_op: WHERE expression

project_op: PROJECT project_list

project_list: project_item ("," project_item)*

project_item: expression [AS? IDENTIFIER]

extend_op: EXTEND extend_list

extend_list: extend_item ("," extend_item)*

extend_item: IDENTIFIER "=" expression

summarize_op: SUMMARIZE summarize_list [BY group_list]

summarize_list: summarize_item ("," summarize_item)*

summarize_item: IDENTIFIER "=" aggregate_func

group_list: IDENTIFIER ("," IDENTIFIER)*

order_op: ORDER BY order_list

order_list: order_item ("," order_item)*

order_item: IDENTIFIER (ASC | DESC)?

take_op: TAKE NUMBER
       | LIMIT NUMBER

top_op: TOP NUMBER BY IDENTIFIER (ASC | DESC)?

join_op: JOIN join_kind? "(" table_source ")" ON_KW join_condition

ON_KW: "ON"i | "on"

join_kind: KIND "=" (INNER | LEFTOUTER | RIGHTOUTER | FULLOUTER | LEFTANTI | RIGHTANTI | LEFTSEMI | RIGHTSEMI)

join_condition: join_key ("," join_key)*

join_key: "$left" "." IDENTIFIER "==" "$right" "." IDENTIFIER

union_op: UNION [union_kind] "(" table_source ("," table_source)* ")"

union_kind: KIND "=" (INNER | OUTER)

distinct_op: DISTINCT project_list

count_op: COUNT

render_op: RENDER render_type

render_type: TIMECHART | COLUMNCHART | PIECHART | TABLE

// Aggregation functions
aggregate_func: COUNT "(" ")"
              | COUNT "(" DISTINCT? expression ")"
              | SUM "(" expression ")"
              | AVG "(" expression ")"
              | MIN "(" expression ")"
              | MAX "(" expression ")"
              | DCOUNT "(" expression ")"
              | PERCENTILE "(" expression "," NUMBER ")"
              | MAKE_SET "(" expression ")"
              | MAKE_LIST "(" expression ")"

// Scalar functions
function_call: IDENTIFIER "(" [arg_list] ")"

arg_list: expression ("," expression)*

// Expressions
expression: or_expr

or_expr: and_expr (OR and_expr)*

and_expr: not_expr (AND not_expr)*

not_expr: NOT? comparison

comparison: additive [compare_op additive]
          | additive CONTAINS STRING
          | additive STARTSWITH STRING
          | additive ENDSWITH STRING
          | additive HAS STRING
          | additive IN value_list
          | additive BETWEEN additive AND additive

compare_op: "==" | "!=" | "<" | ">" | "<=" | ">=" | "=~"

additive: multiplicative (("+" | "-") multiplicative)*

multiplicative: unary (("*" | "/" | "%") unary)*

unary: ("+" | "-" | NOT)? primary

primary: literal
       | column_ref
       | function_call
       | "(" expression ")"
       | array_literal
       | object_literal
       | timespan_literal
       | datetime_literal

column_ref: IDENTIFIER ("." IDENTIFIER)*

array_literal: "dynamic" "(" "[" [expression ("," expression)*] "]" ")"
             | "[" [expression ("," expression)*] "]"

object_literal: "dynamic" "(" "{" [object_pair ("," object_pair)*] "}" ")"
              | "{" [object_pair ("," object_pair)*] "}"

object_pair: (STRING | IDENTIFIER) ":" expression

value_list: "(" expression ("," expression)* ")"

timespan_literal: NUMBER time_unit

time_unit: "d" | "h" | "m" | "s" | "ms"

datetime_literal: DATETIME "(" STRING ")"

literal: STRING | NUMBER | BOOLEAN_LITERAL | NULL

// Keywords
WHERE: "where"i
PROJECT: "project"i
EXTEND: "extend"i
SUMMARIZE: "summarize"i
ORDER: "order"i
BY: "by"i
TAKE: "take"i
LIMIT: "limit"i
TOP: "top"i
JOIN: "join"i
UNION: "union"i
DISTINCT: "distinct"i
COUNT: "count"i
RENDER: "render"i
KIND: "kind"i
AS: "as"i
AND: "and"i
OR: "or"i
NOT: "not"i
IN: "in"i
CONTAINS: "contains"i
STARTSWITH: "startswith"i
ENDSWITH: "endswith"i
HAS: "has"i
BETWEEN: "between"i
ASC: "asc"i
DESC: "desc"i
INNER: "inner"i
LEFTOUTER: "leftouter"i
RIGHTOUTER: "rightouter"i
FULLOUTER: "fullouter"i
LEFTANTI: "leftanti"i
RIGHTANTI: "rightanti"i
LEFTSEMI: "leftsemi"i
RIGHTSEMI: "rightsemi"i
OUTER: "outer"i
SUM: "sum"i
AVG: "avg"i
MIN: "min"i
MAX: "max"i
DCOUNT: "dcount"i
PERCENTILE: "percentile"i
MAKE_SET: "make_set"i
MAKE_LIST: "make_list"i
DATETIME: "datetime"i
TIMECHART: "timechart"i
COLUMNCHART: "columnchart"i
PIECHART: "piechart"i
TABLE: "table"i
NULL: "null"i

BOOLEAN_LITERAL: "true"i | "false"i

// Terminals
IDENTIFIER: /[a-zA-Z_][a-zA-Z0-9_]*/
STRING: /"[^"]*"/ | /'[^']*'/
NUMBER: /\d+(\.\d+)?([eE][+-]?\d+)?/

%import common.WS
%ignore WS
%import common.CPP_COMMENT
%import common.C_COMMENT
%ignore CPP_COMMENT
%ignore C_COMMENT

